---
author: wufm
title: 数据仓库建模
rating: 0
time: 2023-08-12 周六
tags:
 - 数据仓库建模
 - 维度建模
---

## 一、数据仓库与商业智能（DW/BI）

### 1.1 核心架构
![[Drawing 2023-08-16 16.08.41.excalidraw]]

**数据仓库的核心是给用户提供优质的服务。ETL 及其规范、分层等所做的一切都是为了一个更清晰易用的展现层。**

### 1.1 数据处理方式
大致分为两类：
- 联机事务处理OLTP(on-line transaction processing)
- 联机分析处理OLAP(on-line analyticial processing)

#### 1.1.1 OLTP和OLAP的区别

|          | OLTP             | OLAP               |
| -------- | ---------------- | ------------------ |
| 功能     | 保存数据   | 分析数据           |
| 目标     | 更快处理事务     | 高性能完成用户查询 |
| 模型     | 关系模型（3NF）  | 多维模型           |
| 操作类型 | 增删改查         | 查询               |
| 数据量   | 几条或几十条记录 | 成条上万条记录     |


![[Pasted image 20230816171219.png]]


#### 1.1.1 OLAP基本操作

- 钻取（drill-down）：在维的不同层次间的变化，从上层降到下一层，或者说将汇总数据拆分到更细节的数据
- 上卷（roll-up）： 从细粒度数据向高层的聚合
- 切片（slice）：选中维中特定的值进行分析
- 切块（dice）：选中维中特定区间的数据或者某批特定值进行分析
- 旋转（pivot）：即维的位置互换，就像二维表行列转换

![[Pasted image 20230816173551.png]]

### 1.2 主流数据建模方法

#### 1.2.1 ER模型和维度建模的优缺点

| 区分 | ER模型 | 维度建模 |
| ---- | ------ | -------- |
| 优点 |    规范性较好，冗余小    |   技术要求不高，快速上手，敏捷迭代，快速交付；快速完成数据分析需求，提供高效的查询性能       |
| 缺点     |  需要全面了解企业业务、数据和关系；实施周期非常长，成本昂贵；对建模人员要求也非常高，容易烂尾      |   维度表冗余会比较低，视野狭窄       |
#### 1.2.2 ER模型（3NF）
数据仓库之父Bill Inmon推崇。

ER模型也称为三范式。
- **第一范式：每列都是不可再分的最小数据单元**

身高体重字段是两个属性，违反第一范式。

| id  | 姓  | 身高体重 |
| --- | --- | -------- |
| 1   | 吴  | 180/140         |

修正后：

| id  | 姓  | 身高 | 体重 |
| --- | --- | ---- | ---- |
| 1   | 吴  | 180  | 140     |

- **第二范式：满足第一范式，非主键字段完全依赖主键字段**

复合主键维学号字段和学科字段，但是学科学分字段只是部分依赖复合主键。违反第二范式。

| 学号 | 学科 | 成绩 | 学科学分 |
| ---- | ---- | ---- | -------- |
| 1    | 数学 | 100  | 6        |

修正后：

| 学号 | 学科 | 成绩 |
| ---- | ---- | ---- |
| 1    | 数学 | 100  |

| 学科 | 学科学分 |
| ---- | -------- |
| 数学 | 6         |

- **第三范式：满足第二范式，表中的列不能对非主键列有传递依赖**

学生字段依赖id字段，爱好字段依赖学生字段，存在传递依赖，违反第三范式。

| id  | 学生 | 爱好 | 学科 | 分数 |
| --- | ---- | ---- | ---- | ---- |
| 1   | 李四 | 游戏 | 数学 | 100  |

修正后：

| id  | 学生id | 学科 | 分数 |
| --- | ---- | ---- | ---- |
| 1   | 1 | 数学 | 100  |

| 学生id | 爱好 |
| ------ | ---- |
| 1      | 游戏     |


![[Drawing 2023-08-17 09.03.01.excalidraw]]


优点：规范性较好，冗余小
缺点：需要全面了解企业业务、数据和关系；实施周期非常长，成本昂贵；对建模人员要求也非常高，容易烂尾
#### 1.2.3 维度建模
数据仓库领域大师Ralph Kimball倡导。
能同时满足两个需求：
- 以商业用户可理解的方式发布数据
- 提供高效率的查询性能

![[Drawing 2023-08-17 09.47.14.excalidraw]]

优点： 技术要求不高，快速上手，敏捷迭代，快速交付；快速完成数据分析需求，提供高效的查询性能  
缺点：维度表冗余会比较低，视野狭窄
## 二、维度建模概述

### 2.1 维度建模步骤

#### 2.1.1 选择业务过程
应该围绕业务过程组织，例如订单、发货、服务调用等，而不是按照组织中的部门职责划分。多个业务部门往往需要分析来自同一业务过程的相同度量。应该避免多次获取同一个数据源的数据，这样做会产生多个不一致的分析数据库。

业务过程是组织完成的操作型活动。过程的选择很重要，因为过程定义了特定的设计目标以及对粒度、维度和事实的定义。每个过程对应企业数据仓库总线矩阵的一行。

#### 2.1.2 声明粒度
粒度用于确定某一事实表中的行表示什么。

#### 2.1.3 确定维度
维度提供围绕某一业务过程事件所涉及的“谁、什么、何处、何时、为什么、如何”等背景。维度表包含用于过滤及分类事实的描述性属性。

#### 2.1.4 确认事实
事实涉及来自业务过程事件的度量，基本上都是以数量值表示。

### 2.2 事实表技术基础

#### 2.2.1 事实表结构
从最低粒度级别来看，事实表行对应一个度量事件。

#### 2.2.2 事实分类
- 可加
	- 可以与事实表关联的任意维度汇总，如销售数量。
- 半可加
	- 不能对所有维度进行汇总，只能对某些维度汇总，如差额（时间维度不可汇总）。
- 不可加
	- 所有维度都不能汇总，如比率。
#### 2.2.3 事实表分类

|     | 事务事实表 | 周期快照事实表                                                               | 累积快照事实表 |
| --- | ---------- | ---------------------------------------------------------------------------- | -------------- |
|     |   每行对应空间或时间上某点的度量事件         | 每行汇总了发生在某一标准周期，如一天、某周、某月的多个度量事件 |       每行汇总发生在过程开始和结束之间可预测步骤内的度量事件         |
|     |            |                                                                              |                |


- 无事实的事实表
	- 如学生参与课程的事件，可能没有可记录的数字化事实，但该事实行带有一个包含日历天、学生、教师、地点、课程等定义良好的外键。
- 聚集事实表
	- 对原子粒度事实表数据进行简单的数字化上卷操作，目的是为了提高查询性能。
- 合并事实表
	- 通常将来自多个过程的，以相同粒度表示的事实合并为一个单一的合并事实表，这样做能够带来方便。例如现货销售可以与销售预测合并为一张事实表。
- 蜈蚣事实表
	- 日期维度、月份维度、季度维度和年维度等，并将所有的外键包含在一个事实表中，这将产生蜈蚣事实表。应该避免使用蜈蚣事实表，所有这些固定深度的、多对一层次化关联的维度都应该回到他们最细节的粒度上。
### 2.3 维度表技术基础
#### 2.3.1 维度表结构
每个维度表都包含单一的主键列。主键列可以作为与之关联的任何事实表的外键。维度表通常比较宽，是扁平型非规范表，包含大量的低粒度的文本属性。
#### 2.3.2 维度表键的分类

- 代理键
- 自然键
- 持久键
- 超自然键
#### 2.3.3 维度表分类
- 退化维度
- 非规范化扁平维度
- 多层次维度
- 日历日期维度
- 杂项维度
- 雪花维度
- 支架维度

#### 2.3.4 处理缓慢变化维度属性

#### 2.3.5 处理维度层次关系


一致性事实表：如果不同事实表的定义是一致的，则这些一致性事实应该具有相同的命名。
一致性维度表：当不同的维度表的属性具有相同列名和领域内容时，称维度表具有一致性。
企业数据仓库总线矩阵：矩阵的行表示业务过程，列表示维度。
## 三、维度建模的三种模式

### 3.1 星型模型
**由一个事实表和一组维表组成**。像星星一样，一个中心，几个角。


![[Drawing 2023-08-17 09.47.14.excalidraw]]

### 3.2 雪花模型
一个或多个维表没有直接连接到事实表，而是通过其他维表连接到事实表。其图解就像雪花连接一样，故称雪花模式。这种模型尽量不要用（减少表连接的次数，可以显著提升查询效率）。

![[Drawing 2023-08-17 10.01.28.excalidraw]]

### 3.3 星座模型
**星座模型需要多个事实表共享维度表**，因而可以视为星型模型的集合，故称为星座模型。

星座模型是很多数据仓库的常态，因为很多数据仓库都是多个事实表的。星座模型只反映是否有多个事实表，他们之间是否有共享一些维度表。

![[Drawing 2023-08-17 10.01.28.excalidraw 1]]
## 三、数据仓库分层

### 3.1 ods层

### 3.2 dw层

### 3.3 ads层


## 四、数仓规范

